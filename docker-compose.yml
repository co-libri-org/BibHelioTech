name: "bht"
services:
    web:
        image: bht/web:${WEB_TAG:-latest}
        build:
            context: .
            target: bht-prod
        command: gunicorn --bind 0.0.0.0:5000 bht_web:app
        volumes:
            - bht_data:/home/bibheliotech/BibHelioTech/DATA:cached
        cpus: 8
        mem_limit: 32g
        mem_reservation: 16g
        depends_on:
          redis:
            condition: service_started
 

    worker:
      image: bht/web:${WEB_TAG:-latest}
      command: python manage.py run_worker
      volumes:
        - bht_data:/home/bibheliotech/BibHelioTech/DATA:cached
      cpus: 8
      mem_limit: 32g
      mem_reservation: 16g
      depends_on:
        - web

    nginx:
      image: nginx
      volumes:
        - ./resources/web_nginx.docker.conf:/etc/nginx/conf.d/default.conf
      ports:
        - "${WEB_PORT:-80}:80"
      depends_on:
        - web

    redis:
      image: redis:6.2-alpine


volumes:
  bht_data:
