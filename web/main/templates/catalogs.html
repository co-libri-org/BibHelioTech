{% extends "base_table.html" %}
{% block more_head %}
{{ super () }}
<title> {{events | length}} Events to display - {{base_title}}</title>
{% endblock %}
{% block content %}
{% if db_stats.num_events > 0 %}
<blockquote class="text-center">
    <p class="lead fs-4 mb-0">
        {{db_stats.num_papers}} Papers processed to find
    </p>
    <p class="lead fs-4 mb-0">
        {{db_stats.num_events}} Events across {{db_stats.num_missions}} Missions
    </p>
    <p class="lead fs-4 mb-0">
        from {{db_stats.global_start}} to {{db_stats.global_stop}}
    </p>
</blockquote>
<hr class="mt-2 mb-3">
{% endif %}
{#
Show missions found in db as clickable buttons, triggering mission's events display
-----------------------------------------------------------------------------------
#}
<form id="catalog-filter" action="{{url_for('main.catalogs')}}" method="post">
    <h4 class="mb-3">Filters:</h4>
    <div class="form-group">
        <label for="duration-min">Min duration: <span class="duration-val"></span></label>
        <input class="form-control filter-input" id="duration-min" name="duration-min" type="number" value="{{params.duration_min}}"/>
    </div>
    <div class="form-group">
        <label for="duration-max">Max duration: <span class="duration-val"></span></label>
        <input class="form-control filter-input" id="duration-max" name="duration-max" type="number" value="{{params.duration_max}}"/>
    </div>
    <div class="form-group">
        <label for="nconf-min">Min NConf (0.0 - 1.0)</label>
        <input class="form-control filter-input" id="nconf-min" name="nconf-min" type="number" value="{{params.nconf_min}}"
        placeholder="1.0" step="0.01" min="0.0" max="1.0" />
    </div>
    <hr class="mt-2 mb-3">
    <h4 class="mb-3">Available Missions:</h4>
    {% for mission in missions %}
    {% if mission.id in params.selected_missions %}
    {%set checked = "checked"%}
    {% else %}
    {%set checked = ""%}
    {% endif %}
    <label class="btn mission-catalog" title="Show {{mission.num_events}} events for mission {{mission.name}}">
        <input name="missions" type="checkbox" {{ checked }} class="filter-input form-check-input"
               value="{{mission.id}}">
        {{mission.name}}
        <span class="badge bg-light border text-dark">{{mission.num_events}}</span>
    </label>
    {% endfor %}

    <hr class="mt-2 mb-3">
    <input class='btn btn-warning' id="show-events-btn" type="submit" value="Show Events" disabled/>
    <button id="download-catalog"
            class='btn btn-warning'
            title="Download as as HPevents catalog"
            data-events_ids = {{ events_ids }} >
        Download
    </button>
</form>
<hr class="mt-2 mb-3">
{#
Show found events after form submit
-----------------------------------
#}
{% include 'events-table.html' %}

{%  endblock %}

{% block scripts %}
{{ super() }}
<script>
    function format_minutes(minutes) {
        const day = Math.floor(minutes / (24 * 60));
        const hour = Math.floor((minutes % (24 * 60)) / 60);
        const minute = minutes % 60;

        let result = "";
        if (day > 0) {
            result += `${day} day${day > 1 ? 's' : ''} `;
        }
        if (hour > 0 || day > 0) {
            result += `${hour} hour${hour > 1 ? 's' : ''} `;
        }
        result += `${minute} minute${minute > 1 ? 's' : ''}`;

        return result.trim();
    }

    function enable_submit() {

        if( $('#show-events-btn').hasClass( "to-submit")){
           return;
        }
        $('#show-events-btn').prop('disabled', false);
        $('#show-events-btn').addClass('to-submit', 500);
        $('#show-events-btn').toggle( "fade");
        $('#show-events-btn').toggle( "fade");
    }

    function update_duration_span(duration_input){
            var duration_str = format_minutes(duration_input.val());
            duration_input.siblings("label").children("span").html(duration_str);
    }

    $(document).ready(function() {

        // Any duration input span label should be updated at start
        $('input.filter-input[type="number"]').each( function(){
            update_duration_span($(this));
        });

        // Bind input key to duration span update and submit btn blink
        $('input.filter-input[type="number"]').on("input", function(){
            update_duration_span($(this));
            enable_submit();
        });

        // Any check event should turn show 'events button' to color
        $('.filter-input[type=checkbox]').change( enable_submit);

        $('#download-catalog').on('click', function() {
            event.preventDefault();
            let events_ids = $(this).data('events_ids')
            alert(events_ids);
        });

    });

</script>
{%  endblock %}
